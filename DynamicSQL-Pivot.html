<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ol{margin:0;padding:0}table td,table th{padding:0}.c3{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:bottom;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:75pt;border-top-color:#000000;border-bottom-style:solid}.c14{border-right-style:solid;padding:2pt 2pt 2pt 2pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:bottom;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:126.8pt;border-top-color:#000000;border-bottom-style:solid}.c1{background-color:#ffffff;color:#262524;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:"Arial";font-style:normal}.c7{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.c8{color:#262524;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:"Arial";font-style:normal}.c15{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c10{color:#ff9900;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.c17{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c5{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:justify}.c9{padding-top:0pt;padding-bottom:0pt;line-height:1.15;text-align:right}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.15;text-align:left}.c6{border-spacing:0;border-collapse:collapse;margin-right:auto}.c11{orphans:2;widows:2;height:11pt}.c4{background-color:#ffffff;max-width:451.4pt;padding:72pt 72pt 72pt 72pt}.c12{orphans:2;widows:2}.c13{height:11pt}.c0{height:15.8pt}.c16{background-color:#ffffff}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c4"><p class="c2 c12"><span class="c15">* Dynamic SQL for Pivot ( SQL server)</span></p><p class="c2 c12"><span class="c15">-- Objective for this SQL</span></p><p class="c2 c12"><span class="c15">Sometimes, need to add fixed header name for exporting csv. because Month name changes. This SQL will be constructed dynamically and add alias column name.</span></p><p class="c2 c11"><span class="c15"></span></p><p class="c2 c12"><span class="c15">Before Pivot Tables data</span></p><a id="t.cc851d64385b322a6b3a1c4d17db5d2ea4e09fe3"></a><a id="t.0"></a><table class="c6"><tbody><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">Calendarkey</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">CID</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">Sales</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201801</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A001</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">100</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201801</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A002</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">300</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201801</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A003</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">100</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201802</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A001</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">200</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201802</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A002</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">300</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201802</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A003</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">500</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201803</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A001</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">100</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201803</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A002</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">300</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">201803</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A003</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">500</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">--- to 201911</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2 c13"><span class="c7"></span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2 c13"><span class="c7"></span></p></td></tr></tbody></table><p class="c2 c11"><span class="c15"></span></p><p class="c2 c12"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 31.50px; height: 46.57px;"><img alt="" src="images/image1.png" style="width: 31.50px; height: 46.57px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c11"><span class="c15"></span></p><p class="c2 c12"><span class="c15">Pivot data - add alias header name instead of actual month&#39;s name</span></p><a id="t.17c1e13f1501fbb5e8379d2dd6e657eb25ecd7b6"></a><a id="t.1"></a><table class="c6"><tbody><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">CID</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c10">Month0</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c10">Month1</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c10">Month2</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c2"><span class="c10">Month3(...to Month23)</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A001</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">100</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">200</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">100</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c9"><span class="c7">1000</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A002</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">300</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">300</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">300</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c9"><span class="c7">300</span></p></td></tr><tr class="c0"><td class="c3" colspan="1" rowspan="1"><p class="c2"><span class="c7">A003</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">100</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">500</span></p></td><td class="c3" colspan="1" rowspan="1"><p class="c9"><span class="c7">500</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c9"><span class="c7">100</span></p></td></tr></tbody></table><p class="c2 c11"><span class="c15"></span></p><p class="c2 c11"><span class="c15"></span></p><p class="c5 c13 c16"><span class="c17"></span></p><p class="c5"><span class="c1">Set nocount on</span></p><p class="c5"><span class="c1">DECLARE</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; @columns NVARCHAR(MAX) = &#39;&#39;,</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; @months NVARCHAR(MAX) = &#39;&#39;,</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; @sql &nbsp; &nbsp; NVARCHAR(MAX) = &#39;&#39;;</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp;</span></p><p class="c5"><span class="c1">DECLARE @current &nbsp;NVARCHAR(10) =replace(LEFT(CONVERT(varchar, DATEADD(month,-1,GETDATE()),23),8)+&#39;01&#39;,&#39;-&#39;,&#39;&#39;)</span></p><p class="c5"><span class="c1">DECLARE @ymd date = CONVERT(DATE, @current)</span></p><p class="c5"><span class="c1">DECLARE @end int = CAST(replace(DATEADD(month, -23, @ymd),&#39;-&#39;,&#39;&#39;) AS int)</span></p><p class="c5"><span class="c1">&nbsp;</span></p><p class="c5"><span class="c1">-- select the calendar keys</span></p><p class="c5"><span class="c1">SELECT</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; @columns+=QUOTENAME(A.trade_date) + &#39;,&#39;</span></p><p class="c5"><span class="c1">FROM</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; TestA (NOLOCK) as A</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; where A.trade_date between @end and @current</span></p><p class="c5"><span class="c1">GROUP BY A.trade_date</span></p><p class="c5"><span class="c1">ORDER BY trade_date DESC;</span></p><p class="c5 c13 c16"><span class="c8"></span></p><p class="c5"><span class="c1">&mdash; Add alias name for Extracting Month columns of Dynamic SQL</span></p><p class="c5"><span class="c1">SELECT</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp;@months+= &#39;ISNULL(&#39;+QUOTENAME(A.trade_date) + &#39;,0) &#39; + QUOTENAME(&#39;month&#39;+LTRIM(STR(ROW_NUMBER() OVER(ORDER BY A.trade_date DESC)-1)) ) + &#39;,&#39; &nbsp; </span></p><p class="c5"><span class="c1">FROM</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; TestA (NOLOCK) as A</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; where A.trade_date between @end and @current</span></p><p class="c5"><span class="c1">GROUP BY A.trade_date</span></p><p class="c5"><span class="c1">ORDER BY A.trade_date DESC</span></p><p class="c5 c13"><span class="c8"></span></p><p class="c5"><span class="c1">-- remove the last comma</span></p><p class="c5"><span class="c1">SET @columns = LEFT(@columns, LEN(@columns) - 1);</span></p><p class="c5"><span class="c1">SET @months = LEFT(@months, LEN(@months) - 1);</span></p><p class="c5 c13 c16"><span class="c8"></span></p><p class="c5 c16"><span class="c8">-- construct dynamic SQL</span></p><p class="c5"><span class="c1">SET @sql =&#39;SET NOCOUNT ON;</span></p><p class="c5"><span class="c1">SELECT &#39; + @current &nbsp;+&#39; timeindex,CID,, &#39; + @months + &#39; FROM &nbsp;</span></p><p class="c5"><span class="c1">(</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; SELECT</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CID</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,PRODUCT</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,ISNULL([Sales],0) AS Sales</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,A.trade_date </span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; FROM</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; TestA as A (NOLOCK) inner join</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; Customer as c &nbsp;(NOLOCK) on A.customerkey = c.customerkey </span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp; WHERE A.[CalendarKey] between &#39;+cast(@end as varchar(10))+&#39; and &#39; +cast(@current as varchar(10)) +&#39;</span></p><p class="c5"><span class="c1">) t</span></p><p class="c5"><span class="c1">PIVOT(</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp;SUM(Sales)</span></p><p class="c2 c12"><span class="c1">&nbsp; &nbsp; &nbsp;FOR trade_date IN (&#39;+ @columns +&#39;)</span></p><p class="c5"><span class="c1">) AS pivot_table;&#39;;</span></p><p class="c5"><span class="c1">&nbsp;</span></p><p class="c5"><span class="c1">-- execute the dynamic SQL</span></p><p class="c5 c16"><span class="c8">EXECUTE sp_executesql @sql;</span></p><p class="c2 c11"><span class="c17"></span></p></body></html>